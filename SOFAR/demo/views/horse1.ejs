<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../public/all.css/shawnCSS/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="../public/js/EllisJS/_js/jquery.min.js"></script>
    <script src="../public/js/EllisJS/_js/popper.min.js"></script>
    <script src="../public/js/EllisJS/_js/bootstrap.min.js"></script>
    <script src="./jquery/_js/jquery-3.6.0.js"></script>
    <script src="https://kit.fontawesome.com/3654a6b910.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-router/dist/vue-router.js"></script>
    <script src="https://cdn.staticfile.org/axios/0.18.0/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../public/all.css/Ellis/ellis.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>東京都市賽馬場</title>


</head>

<body style="background-image: url(../public/images/EllisImages/page03/背景花4.jpeg);">
    <%- include('navbar.ejs') %>


        <div id="username" style="display:none"><%= userSeeeionName%></div>
        <div id="userid" style="display:none"><%= userId%></div>

        <div class="container">
            <div class="row d-flex">
                <div class="col-12 col-lg-7 col-md-10 col-sm-12 mx-auto">
                    <div class="cardTitle">
                        <h4 class="p-2 m-2 mx-auto" id="tag">{{name}} &nbsp|| &nbsp {{tag}}</h4>
                        <div class="like">
                            <a class="btn" id="lovebtn" type="button"><i class="fa-regular fa-heart">最愛</i></a>
                        </div>
                    </div>
                    <div class="primary-content wrapper-content mx-auto col-12 col-md-12">
                        <!--輪播圖片，控制器，淡入淡出效果-->
                        <div id="hpcarousel">
                            <div id="carouselExampleFade" class="carousel slide carousel-fade" data-ride="carousel">
                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <img class="d-block w-100" src="../public/images/EllisImages/page03/大井.png"
                                            alt="First slide">
                                    </div>
                                    <div class="carousel-item">
                                        <img class="d-block w-100" src="../public/images/EllisImages/page03/大井2.jpg"
                                            alt="Second slide">
                                    </div>
                                    <div class="carousel-item">
                                        <img class="d-block w-100" src="../public/images/EllisImages/page03/大井3.jpg"
                                            alt="Third slide">
                                    </div>

                                    <ol class="carousel-indicators">
                                        <li data-target="#carouselExampleFade" data-slide-to="0" class="active"></li>
                                        <li data-target="#carouselExampleFade" data-slide-to="1"></li>
                                        <li data-target="#carouselExampleFade" data-slide-to="2"></li>
                                    </ol>
                                </div>
                                <a class="carousel-control-prev" href="#carouselExampleFade" role="button"
                                    data-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="sr-only">Previous</span>
                                </a>
                                <a class="carousel-control-next" href="#carouselExampleFade" role="button"
                                    data-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="none"></span>
                                    <span class="sr-only">Next</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="cardCont mt-5 p-3" style="background-color: #FFE5E5; font-size:large">
                        <h4>內容介紹:</h4>
                        <span id="const">
                            {{message}}
                        </span>
                    </div>
                    <div class="text-right">
                        <hr>
                        <span id="area">
                            {{area}}
                        </span>
                        <br>
                        <span>
                            連絡電話:+81 3-3763-2151
                        </span>
                        <br>
                        <span>
                            地點:東京都品川区勝島2丁目1-2
                        </span>
                    </div>
                </div>
                <div class="col-12 col-lg-5 col-md-8 col-sm-12 mx-auto mt-5">
                    <div>
                        <h4>地圖</h4>
                        <iframe
                            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3244.4395798295914!2d139.73863095099532!3d35.592221880118004!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x601861c5464d5577%3A0x811ba613aee0e815!2z5aSn5LqV6LO96aas5aC0!5e0!3m2!1szh-TW!2stw!4v1656146262216!5m2!1szh-TW!2stw"
                            width="98%" height="250"></iframe>
                    </div>

                    <div class="container mx-auto" id="app">
                        <div class="message">
                            <v-textarea v-model="message"></v-textarea>
                            <button @click="handleSend">送出</button>
                        </div>
                        <div class="listhight">
                            <div class="list">
                                <v-list :list="list" @reply="handleReply" @delete="handleDelete"></v-list>
                            </div>
                        </div>
                    </div>

                    <script type="text/template" id="v-textarea">
                            <div>
                                <h4>留言內容 : </h4>
                                <textarea :value="value" @input="$emit('input', $event.target.value)" 
                                placeholder="請輸入留言內容" type="text"
                                ></textarea>
                            </div>
                        </script>

                    <script type="text/template" id="v-list">
                            <div>
                                <div class="list-item" v-for="(item, index) in list">
                                    <span>{{ item.name }}</span>
                                    <div class="list-msg">
                                        <p>{{ item.message }}</p>
                                        <p class="text-right">{{ item.timer}}</p>
                                        <hr>
                                        <a class="list-reply" @click="handleDelete(index)">&nbsp;&nbsp;&nbsp;&nbsp;刪除</a>
                                        <a class="list-reply" @click="handleReply(index)">回覆</a>
                                    </div>
                                </div>
                            </div>
                        </script>
                    <script>
                        Vue.component('v-textarea', {
                            template: '#v-textarea',
                            props: {
                                value: {
                                    type: String,
                                    default: ''
                                }
                            }
                        });

                        Vue.component("v-list", {
                            template: '#v-list',
                            props: {
                                list: {
                                    type: Array,
                                    default: []
                                }
                            },
                            data: function () {
                                return {
                                    itemlist: this.list
                                }
                            },
                            methods: {
                                handleReply: function (index) {
                                    this.$emit("reply", index);
                                },
                                handleDelete: function (index) {
                                    this.$emit("delete", index);
                                }
                            }
                        });
                        var app = new Vue({
                            el: "#app",
                            data: function () {
                                return {
                                    username: $("#username").text(),
                                    message: "",
                                    ctime: new Date(),
                                    list: [],
                                }
                            },

                            methods: {
                                getTime: () => {
                                    var date = new Date();
                                    var year = date.getFullYear();
                                    var month = date.getMonth() + 1;

                                    month = month < 10 ? '0' + month : month;

                                    var day = date.getDate()
                                    day = day < 10 ? '0' + day : day;

                                    var hour = date.getHours()
                                    hour = hour < 10 ? '0' + hour : hour;

                                    var minute = date.getMinutes()
                                    minute = minute < 10 ? '0' + minute : minute;

                                    var s = date.getSeconds()
                                    s = s < 10 ? '0' + s : s;
                                    let totime = year + '-' + month + '-' + day + '-' + hour + ':' + minute + ':' + s;

                                    return totime;
                                },
                                handleSend: function () {

                                    onkeyup = "value=value.replace(/\s+/g,'')"
                                    if (this.message === '') {
                                        alert("請先輸入留言內容");
                                        return;
                                    }

                                    this.list.push({
                                        name: this.username,
                                        message: this.message,
                                        timer: this.getTime()
                                    });
                                    // this.message = '';
                                    // this.username = $("#username").text();
                                    // this.timer = '';

                                    var adname = this.username;
                                    var admessage = this.message;
                                    var adtimer = this.getTime();

                                    axios.post("http://localhost:3000/onlyMember/AddMessage" + "/" + adname + "/" + admessage + "/" + adtimer,
                                        {
                                            name: this.username,
                                            message: this.message,
                                            timer: this.getTime()
                                        }
                                    )
                                    window.location.reload();
                                },
                                handleReply: function (index) {
                                    var name = this.list[index].name;
                                    this.message = "回覆@" + name + ": ";
                                },
                                handleDelete: function (index) {
                                    var adno = this.list[index].No
                                    axios.post("http://localhost:3000/onlyMember/DeleteMessage" + "/" + adno,
                                        {
                                            no: this.list[index].No
                                        }
                                    )
                                    this.list.splice(index, 1); //畫面上的
                                    window.location.reload();
                                },
                                getInfo() {
                                    axios.get("http://localhost:3000/onlyMember/getMessage")//發出取得請求
                                        .then((response) => {
                                            this.list = response.data
                                        })
                                        .catch((error) => {
                                            alert("出錯了")
                                        })
                                }
                            },
                            created() {
                                this.getInfo()
                            }
                        })

                    </script>
                    <script>//頁面資料
                        var item = [];
                        var memLove = [];
                        var userId = $("#userid").text();
                        var userName = $("#username").text();

                        $.ajax({
                            type: "GET",
                            url: "http://localhost:3000/onlyMember/getSpecialViewData",
                            async: false,
                            success: function (data) {
                                item = JSON.parse(data);
                            }
                        });
                        new Vue({
                            el: '#const',
                            data: {
                                message: item[0].ViewText,
                            }
                        });
                        new Vue({
                            el: '#area',
                            data: {
                                area: item[0].Area,
                            }
                        });
                        new Vue({
                            el: '#tag',
                            data: {
                                tag: item[0].ViewTag,
                                name: item[0].ViewName,
                            }
                        });

                        $.ajax({
                            //已蒐藏的情況下，點亮我的最愛
                            type: "GET",
                            url: "http://localhost:3000/onlyMember/getspMemberCollectViewData/" + userName.trim(),
                            async: false,
                            success: function (data) {
                                spItem = JSON.parse(data);
                            }
                        });

                        spItem.forEach(p => {
                            if (item[0].ViewName == p.ViewName) {
                                $('i').removeClass("fa-regular fa-heart");
                                $('i').addClass("fa-solid fa-heart");
                            }
                        })

                        $.ajax({
                            //取得所有會員限定景點資料
                            type: "GET",
                            url: "http://localhost:3000/onlyMember/getspMemberCollectViewData/" + userId,
                            async: false,
                            success: function (data) {
                                memLove = JSON.parse(data);
                            }
                        });

                        $("i").on("click", function () {
                            if (this.className === 'fa-regular fa-heart') {
                                $(this).removeClass('fa-regular fa-heart');
                                $(this).addClass('fa-solid fa-heart');
                                $.ajax({
                                    type: "POST",
                                    url: 'http://localhost:3000/onlyMember/addspmemberviewdata/' + userId + "/" + item[0].ViewID,
                                    async: false,
                                    success: function (data) {
                                        alert("已加入最愛");
                                    },
                                    error: function (data) {
                                        alert("加入失敗");
                                    }
                                });

                            } else if (this.className === 'fa-solid fa-heart') {
                                $(this).removeClass('fa-solid fa-heart');
                                $(this).addClass('fa-regular fa-heart');
                                $.ajax({
                                    type: "POST",
                                    url: 'http://localhost:3000/onlyMember/deletespmemberviewdata/' + userId + "/" + item[0].ViewID,
                                    async: false,
                                    success: function (data) {
                                        alert("已取消最愛");
                                    },
                                    error: function (data) {
                                        alert("取消失敗");
                                    }
                                });
                            }
                        });

                    </script>
                </div>
            </div>
        </div>

        <%- include('footer.ejs') %>

</body>

</html>